#!/usr/bin/env tsx

/**
 * Script: Criar Templates Padr√£o
 * 
 * Cria templates de normaliza√ß√£o padr√£o para come√ßar a usar o sistema
 */

import { db } from '../lib/db'
import { normalizationTemplates } from '../lib/db/schema/normalization-templates'
import { classificationConfigs } from '../lib/db/schema/classification-configs'
import { organizations } from '../lib/db/schema/organizations'

async function main() {
  console.log('üîß Criando templates padr√£o...\n')

  try {
    // Buscar primeira organiza√ß√£o para criar templates de exemplo
    const orgs = await db.select().from(organizations).limit(1)
    
    if (orgs.length === 0) {
      console.log('‚ö†Ô∏è  Nenhuma organiza√ß√£o encontrada. Crie uma organiza√ß√£o primeiro.')
      process.exit(0)
    }

    const orgId = orgs[0].id
    console.log(`üìã Usando organiza√ß√£o: ${orgs[0].name} (${orgId})\n`)

    // Template 1: Documentos Gerais
    const [generalTemplate] = await db
      .insert(normalizationTemplates)
      .values({
        organizationId: orgId,
        name: 'Documentos Gerais',
        description: 'Template padr√£o para documentos gerais (contratos, relat√≥rios, etc)',
        baseType: 'document',
        category: 'geral',
        tableName: 'documentos_gerais',
        fields: [
          {
            fieldName: 'titulo',
            displayName: 'T√≠tulo do Documento',
            fieldType: 'text',
            isRequired: true,
            description: 'T√≠tulo ou assunto principal',
          },
          {
            fieldName: 'data_documento',
            displayName: 'Data do Documento',
            fieldType: 'date',
            isRequired: false,
            description: 'Data de cria√ß√£o ou emiss√£o',
          },
          {
            fieldName: 'emissor',
            displayName: 'Emissor',
            fieldType: 'text',
            isRequired: false,
            description: 'Quem emitiu o documento',
          },
          {
            fieldName: 'destinatario',
            displayName: 'Destinat√°rio',
            fieldType: 'text',
            isRequired: false,
            description: 'Para quem √© o documento',
          },
          {
            fieldName: 'valor',
            displayName: 'Valor',
            fieldType: 'numeric',
            isRequired: false,
            description: 'Valor monet√°rio se aplic√°vel',
          },
          {
            fieldName: 'observacoes',
            displayName: 'Observa√ß√µes',
            fieldType: 'text',
            isRequired: false,
            description: 'Observa√ß√µes relevantes',
          },
        ],
        sqlTableCreated: false,
        isActive: true,
        isDefaultForBaseType: true,
      })
      .returning()

    console.log(`‚úÖ Template criado: ${generalTemplate.name}`)

    // Config de IA para template geral
    const [generalConfig] = await db
      .insert(classificationConfigs)
      .values({
        organizationId: orgId,
        normalizationTemplateId: generalTemplate.id,
        name: 'Config IA - Documentos Gerais',
        description: 'Configura√ß√£o de IA para extra√ß√£o de dados de documentos gerais',
        systemPrompt: `Voc√™ √© um assistente especializado em extrair informa√ß√µes de documentos.
Analise o documento fornecido e extraia as seguintes informa√ß√µes:
- T√≠tulo ou assunto principal
- Data do documento (se mencionada)
- Emissor (quem criou/enviou)
- Destinat√°rio (para quem √© direcionado)
- Valor monet√°rio (se houver)
- Observa√ß√µes relevantes

Retorne os dados no formato JSON solicitado.`,
        modelProvider: 'openai',
        modelName: 'gpt-4',
        temperature: '0.10',
        maxInputTokens: 8000,
        maxOutputTokens: 2000,
        enableRAG: true,
        enableChunking: true,
        chunkSize: 800,
        isActive: true,
        isDefault: true,
      })
      .returning()

    console.log(`‚úÖ Config de IA criada: ${generalConfig.name}`)

    // Template 2: Contratos
    const [contractTemplate] = await db
      .insert(normalizationTemplates)
      .values({
        organizationId: orgId,
        name: 'Contratos',
        description: 'Template para contratos de presta√ß√£o de servi√ßos, compra/venda, etc',
        baseType: 'document',
        category: 'juridico',
        tableName: 'contratos',
        fields: [
          {
            fieldName: 'tipo_contrato',
            displayName: 'Tipo de Contrato',
            fieldType: 'text',
            isRequired: true,
            description: 'Tipo (presta√ß√£o de servi√ßos, compra/venda, etc)',
          },
          {
            fieldName: 'numero_contrato',
            displayName: 'N√∫mero do Contrato',
            fieldType: 'text',
            isRequired: false,
          },
          {
            fieldName: 'contratante',
            displayName: 'Contratante',
            fieldType: 'text',
            isRequired: true,
          },
          {
            fieldName: 'contratado',
            displayName: 'Contratado',
            fieldType: 'text',
            isRequired: true,
          },
          {
            fieldName: 'data_inicio',
            displayName: 'Data de In√≠cio',
            fieldType: 'date',
            isRequired: false,
          },
          {
            fieldName: 'data_termino',
            displayName: 'Data de T√©rmino',
            fieldType: 'date',
            isRequired: false,
          },
          {
            fieldName: 'valor_total',
            displayName: 'Valor Total',
            fieldType: 'numeric',
            isRequired: false,
          },
          {
            fieldName: 'objeto',
            displayName: 'Objeto do Contrato',
            fieldType: 'text',
            isRequired: false,
          },
        ],
        sqlTableCreated: false,
        isActive: true,
        isDefaultForBaseType: false,
      })
      .returning()

    console.log(`‚úÖ Template criado: ${contractTemplate.name}`)

    // Config de IA para contratos
    await db
      .insert(classificationConfigs)
      .values({
        organizationId: orgId,
        normalizationTemplateId: contractTemplate.id,
        name: 'Config IA - Contratos',
        description: 'Configura√ß√£o de IA para extra√ß√£o de dados de contratos',
        systemPrompt: `Voc√™ √© um assistente jur√≠dico especializado em analisar contratos.
Extraia as seguintes informa√ß√µes do contrato:
- Tipo de contrato
- N√∫mero do contrato (se houver)
- Partes: Contratante e Contratado
- Datas de vig√™ncia (in√≠cio e t√©rmino)
- Valor total
- Objeto/finalidade do contrato

Retorne os dados estruturados em JSON.`,
        modelProvider: 'openai',
        modelName: 'gpt-4',
        temperature: '0.05',
        maxInputTokens: 12000,
        maxOutputTokens: 2000,
        enableRAG: true,
        enableChunking: true,
        chunkSize: 1000,
        isActive: true,
        isDefault: true,
      })

    console.log(`‚úÖ Config de IA criada para contratos`)

    console.log('\n' + '='.repeat(60))
    console.log(`‚úÖ Templates padr√£o criados com sucesso!`)
    console.log(`   - Documentos Gerais`)
    console.log(`   - Contratos`)
    console.log('\n‚ö†Ô∏è  Lembre-se de criar as tabelas no banco antes de usar:`)
    console.log(`   Execute: npm run migrate ou use o endpoint /api/documents/normalize/create-table`)
    console.log('='.repeat(60))
  } catch (error) {
    console.error('‚ùå Erro ao criar templates:', error)
    process.exit(1)
  }

  process.exit(0)
}

main()

