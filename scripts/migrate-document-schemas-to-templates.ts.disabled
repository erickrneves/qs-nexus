#!/usr/bin/env tsx

/**
 * Script de Migra√ß√£o: Document Schemas ‚Üí Normalization Templates + Classification Configs
 * 
 * Migra schemas existentes (que misturam estrutura + IA) para a nova arquitetura:
 * - normalization_templates: estrutura de dados (SEM IA)
 * - classification_configs: configura√ß√µes de IA (separado)
 */

import { db } from '../lib/db'
import { documentSchemas } from '../lib/db/schema/metadata-schemas'
import { normalizationTemplates } from '../lib/db/schema/normalization-templates'
import { classificationConfigs } from '../lib/db/schema/classification-configs'
import { eq } from 'drizzle-orm'

async function main() {
  console.log('üîÑ Iniciando migra√ß√£o de Document Schemas para Templates + Configs...\n')

  try {
    // Buscar todos os document_schemas existentes
    const existingSchemas = await db
      .select()
      .from(documentSchemas)
      .where(eq(documentSchemas.isActive, true))

    console.log(`üìä Encontrados ${existingSchemas.length} schemas para migrar\n`)

    let successCount = 0
    let errorCount = 0

    for (const schema of existingSchemas) {
      console.log(`\nüìù Processando: ${schema.name}`)
      console.log(`   Org: ${schema.organizationId}`)
      console.log(`   Tipo: ${schema.baseType}`)

      try {
        // 1. Criar Normalization Template (estrutura pura)
        const [template] = await db
          .insert(normalizationTemplates)
          .values({
            organizationId: schema.organizationId,
            name: schema.name,
            description: schema.description || `Migrado de schema: ${schema.name}`,
            baseType: schema.baseType as any,
            category: schema.category,
            tableName: schema.tableName,
            fields: schema.fields, // Mant√©m defini√ß√£o de campos
            sqlTableCreated: schema.sqlTableCreated || false,
            sqlTableCreatedAt: schema.sqlTableCreatedAt,
            sqlCreateStatement: schema.sqlCreateStatement,
            isActive: true,
            isDefaultForBaseType: schema.isDefaultForBaseType || false,
            documentsProcessed: 0,
            createdBy: schema.createdBy,
            createdAt: schema.createdAt,
            updatedAt: new Date(),
          })
          .returning()

        console.log(`   ‚úÖ Template criado: ${template.id}`)

        // 2. Criar Classification Config (IA separada)
        const [config] = await db
          .insert(classificationConfigs)
          .values({
            organizationId: schema.organizationId,
            normalizationTemplateId: template.id,
            name: `Config IA - ${schema.name}`,
            description: `Configura√ß√£o de IA para ${schema.name}`,
            systemPrompt: schema.aiSystemPrompt || 'Voc√™ √© um assistente que extrai informa√ß√µes de documentos.',
            modelProvider: schema.aiModelProvider || 'openai',
            modelName: schema.aiModelName || 'gpt-4',
            temperature: schema.aiTemperature || '0.10',
            maxInputTokens: schema.aiMaxInputTokens || 8000,
            maxOutputTokens: schema.aiMaxOutputTokens || 2000,
            enableRAG: true,
            enableChunking: true,
            chunkSize: 800,
            isActive: true,
            isDefault: true, // Primeira config √© default
            documentsClassified: 0,
            createdBy: schema.createdBy,
            createdAt: schema.createdAt,
            updatedAt: new Date(),
          })
          .returning()

        console.log(`   ‚úÖ Config de IA criada: ${config.id}`)

        successCount++
      } catch (error) {
        console.error(`   ‚ùå Erro ao migrar schema ${schema.name}:`, error)
        errorCount++
      }
    }

    console.log('\n' + '='.repeat(60))
    console.log(`‚úÖ Migra√ß√£o conclu√≠da!`)
    console.log(`   Sucesso: ${successCount}`)
    console.log(`   Erros: ${errorCount}`)
    console.log('='.repeat(60))
  } catch (error) {
    console.error('‚ùå Erro fatal na migra√ß√£o:', error)
    process.exit(1)
  }

  process.exit(0)
}

main()

